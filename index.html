<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°°ë„ˆ ì´ë¯¸ì§€ ìƒì„±ê¸°</title>
    <style>
        body {
            font-family: sans-serif;
            background: #f7f7f7;
            margin: 0;
            padding: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .upload-area {
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
            width: 100%;
        }

        .upload-area label {
            margin-bottom: 5px;
            font-weight: bold;
        }

        .upload-area input[type="file"] {
            margin-bottom: 10px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            margin-bottom: 10px;
        }

        /* í™œì„±í™”ëœ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        button.active {
            background-color: #007bff;
            color: white;
        }

        /* ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .button-container {
            text-align: center;
            margin-bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* ê° ë²„íŠ¼ì— ëŒ€í•œ ìŠ¤íƒ€ì¼ (margin ì¶”ê°€) */
        .button-container button {
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¨ ë°°ë„ˆ ì´ë¯¸ì§€ ìë™ ìƒì„±ê¸°</h1>

        <div class="button-container">
            <button class="size-button" data-width="315" data-height="186" data-radius="20" data-mime="image/png">315x186 (PNG)</button>
            <button class="size-button" data-width="232" data-height="232" data-radius="15" data-mime="image/png">232x232 (PNG)</button>
            <button class="size-button" data-width="1200" data-height="497" data-radius="0" data-mime="image/jpeg">1200x497 (JPG)</button>
        </div>

        <div class="upload-area">
            <label for="templateInput">ë°°ë„ˆ í…œí”Œë¦¿ ì—…ë¡œë“œ:</label>
            <input type="file" id="templateInput" accept="image/*" />

            <label for="visualsInput">ë¹„ì£¼ì–¼ ì´ë¯¸ì§€ë“¤ ì—…ë¡œë“œ (ì—¬ëŸ¬ ê°œ):</label>
            <input type="file" id="visualsInput" accept="image/*" multiple />
        </div>

        <div class="button-container">
            <button id="downloadBtn">ë‹¤ìš´ë¡œë“œ</button>
            <button id="resetBtn">ì´ˆê¸°í™”</button>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        const templateInput = document.getElementById('templateInput');
        const visualsInput = document.getElementById('visualsInput');
        const buttonContainer = document.querySelector('.button-container');
        const downloadBtn = document.getElementById('downloadBtn');
        const resetBtn = document.getElementById('resetBtn');
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        let templateImage = null;
        let visualImages = [];
        let selectedButton = null;
        let bannerDataURLs = [];
        let canvasWidth = 1029;
        let canvasHeight = 258;

        // ì´ë¯¸ì§€ ë¡œë“œ í•¨ìˆ˜ (Promise ê¸°ë°˜)
        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => resolve(img);
                img.onerror = () => reject(e);
                img.src = src;
            });
        }

        // ì´ˆê¸°í™” í•¨ìˆ˜
        function resetState() {
            templateImage = null;
            visualImages = [];
            selectedButton = null;
            bannerDataURLs = [];
            templateInput.value = '';
            visualsInput.value = '';
            canvasWidth = 1029;
            canvasHeight = 258;
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            ctx.clearRect(0, 0, canvasWidth, canvasHeight);
        }

        // ë°°ë„ˆ í…œí”Œë¦¿ ë° ë¹„ì£¼ì–¼ ì´ë¯¸ì§€ ë¡œë“œ í•¨ìˆ˜
        async function loadImages() {
            const templateFile = templateInput.files[0];
            const files = Array.from(visualsInput.files);

            if (!templateFile || files.length === 0) {
                alert('ë°°ë„ˆ í…œí”Œë¦¿ê³¼ ë¹„ì£¼ì–¼ ì´ë¯¸ì§€ë¥¼ ëª¨ë‘ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                templateImage = await loadImage(URL.createObjectURL(templateFile));
                visualImages = await Promise.all(files.map(file => loadImage(URL.createObjectURL(file))));

                // ì´ë¯¸ì§€ ë¡œë”© í›„ ì„ íƒëœ ë²„íŠ¼ì— ëŒ€í•´ ìœ íš¨ì„± ê²€ì‚¬ ë° í•©ì„± ì§„í–‰
                if (selectedButton) {
                    processBanner(selectedButton);
                } else {
                    alert('ì´ë¯¸ì§€ ë¡œë”© ì™„ë£Œ! px ì‚¬ì´ì¦ˆ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”');
                }
            } catch (error) {
                console.error("ì´ë¯¸ì§€ ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                alert('ì´ë¯¸ì§€ ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function removeActiveClasses() {
            document.querySelectorAll('.button-container button').forEach(btn => btn.classList.remove('active'));
        }

        // ì´ë¯¸ì§€ ì‚¬ì´ì¦ˆ ê²€ì¦ í•¨ìˆ˜
        function validateImageSize(img, width, height) {
            const aspectRatio = width / height;
            const imgAspectRatio = img.width / img.height;

            // ì •í™•íˆ ì¼ì¹˜í•˜ê±°ë‚˜, ê°€ë¡œ ì„¸ë¡œ ë¹„ìœ¨ì´ ê°™ë‹¤ë©´ true ë°˜í™˜
            return (img.width === width && img.height === height) || (Math.abs(aspectRatio - imgAspectRatio) < 0.01); // ì˜¤ì°¨ë²”ìœ„ 0.01
        }

        // ì´ë¯¸ì§€ í•©ì„± í•¨ìˆ˜
        function drawVisualImage(width, height, radius, mimeType, img, offsetX = 0, offsetY = 0) {
            // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
            canvasWidth = (width === 1200) ? 1200 : 1029;
            canvasHeight = (width === 1200) ? 600 : 258;
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;

            ctx.clearRect(0, 0, canvasWidth, canvasHeight);
            ctx.drawImage(templateImage, 0, 0, canvasWidth, canvasHeight);

            // ë‘¥ê·¼ ëª¨ì„œë¦¬ í´ë¦¬í•‘ ê²½ë¡œ ì„¤ì • ë° ì´ë¯¸ì§€ í•©ì„±
            if (radius > 0) {
                ctx.beginPath();
                ctx.moveTo(offsetX + radius, offsetY);
                ctx.lineTo(offsetX + width - radius, offsetY);
                ctx.quadraticCurveTo(offsetX + width, offsetY, offsetX + width, offsetY + radius);
                ctx.lineTo(offsetX + width, offsetY + height - radius);
                ctx.quadraticCurveTo(offsetX + width, offsetY + height, offsetX + width - radius, offsetY + height);
                ctx.lineTo(offsetX + radius, offsetY + height);
                ctx.quadraticCurveTo(offsetX, offsetY + height, offsetX, offsetY + height - radius);
                ctx.lineTo(offsetX, offsetY + radius);
                ctx.quadraticCurveTo(offsetX, offsetY, offsetX + radius, offsetY);
                ctx.closePath();
                ctx.clip();
            }
            ctx.drawImage(img, offsetX, offsetY, width, height);
            return canvas.toDataURL(mimeType, (mimeType === 'image/jpeg' ? 0.9 : 1));
        }

        // ë°°ë„ˆ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ ì²˜ë¦¬ í•¨ìˆ˜
        async function processBanner(button) {
            if (!visualImages.length || !templateImage) {
                alert('ë°°ë„ˆ í…œí”Œë¦¿ê³¼ ë¹„ì£¼ì–¼ ì´ë¯¸ì§€ë¥¼ ëª¨ë‘ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!');
                return;
            }

            const width = parseInt(button.dataset.width);
            const height = parseInt(button.dataset.height);
            const radius = parseInt(button.dataset.radius);
            const mimeType = button.dataset.mime;
            let offsetX = 0;
            let offsetY = 0;

            // ì˜¤í”„ì…‹ ê°’ ì„¤ì •
            if (width === 315 && height === 186) {
                offsetX = 48;
                offsetY = 36;
            } else if (width === 232 && height === 232) {
                offsetX = 260;
                offsetY = 13;
            } else if (width === 1200 && height === 497) {
                offsetY = 193;
            }

            bannerDataURLs = []; // ì´ˆê¸°í™”
            
                // ì´ë¯¸ì§€ í•©ì„±
                for (const img of visualImages) {
                    if (!validateImageSize(img, width, height)) {
                        alert(`ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ì¤‘ í•˜ë‚˜ ì´ìƒì˜ ì´ë¯¸ì§€ ì‚¬ì´ì¦ˆê°€ ì„ íƒëœ ë²„íŠ¼ ì‚¬ì´ì¦ˆì™€ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
                        return;
                    }
                    const bannerData = drawVisualImage(width, height, radius, mimeType, img, offsetX, offsetY);
                    bannerDataURLs.push(bannerData);
                }
                alert(`${button.innerText} ë°°ë„ˆê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
}

        // ë°°ë„ˆ ìƒì„± ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        buttonContainer.addEventListener('click', (event) => {
            if (event.target.tagName === 'BUTTON') {
                removeActiveClasses();
                const button = event.target;
                button.classList.add('active');
                selectedButton = button;
                processBanner(button);
            }
        });

        // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        downloadBtn.addEventListener('click', async () => {
    if (!selectedButton) {
        alert('px ì‚¬ì´ì¦ˆ ë²„íŠ¼ì„ ë¨¼ì € ëˆŒëŸ¬ì£¼ì„¸ìš”!');
        return;
    }

    if (!bannerDataURLs || bannerDataURLs.length === 0) {
        alert('ìƒì„±ëœ ë°°ë„ˆê°€ ì—†ìŠµë‹ˆë‹¤. ë°°ë„ˆë¥¼ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”!');
        return;
    }

    const zip = new JSZip();
    const width = parseInt(selectedButton.dataset.width);
    const height = parseInt(selectedButton.dataset.height);
    const mimeType = selectedButton.dataset.mime;

    for (let i = 0; i < visualImages.length; i++) {
        const bannerData = bannerDataURLs[i];
        if (!bannerData) continue;  // ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ê±´ë„ˆëœ€
        const fileName = `banner_${width}x${height}_${i + 1}.${mimeType.split('/')[1]}`;
        const base64Image = bannerData.split(',')[1];
        zip.file(fileName, base64Image, {
            base64: true
        });
    }

    try {
        const content = await zip.generateAsync({
            type: 'blob'
        });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(content);
        link.download = 'banners.zip';
        link.click();
    } catch (error) {
        console.error("ZIP íŒŒì¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        alert('ZIP íŒŒì¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
});


        // ì´ˆê¸°í™” ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        resetBtn.addEventListener('click', () => {
            removeActiveClasses();
            resetState();
            alert("ì´ˆê¸°í™” ë˜ì—ˆìŠµë‹ˆë‹¤. í…œí”Œë¦¿ê³¼ ë¹„ì£¼ì–¼ ì´ë¯¸ì§€ë¥¼ ë‹¤ì‹œ ì—…ë¡œë“œí•˜ê³  px ì‚¬ì´ì¦ˆ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”");
        });

        // í…œí”Œë¦¿, ë¹„ì£¼ì–¼ ì´ë¯¸ì§€ ë¡œë“œ
        templateInput.addEventListener('change', loadImages);
        visualsInput.addEventListener('change', loadImages);

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.onload = () => {
            resetState();
        }
    </script>
</body>

</html>
